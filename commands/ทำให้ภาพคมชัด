const axios = require("axios");
const sharp = require("sharp");

module.exports = {
  config: {
    name: "sharpen",
    description: "ทำให้ภาพคมชัด"
  },
  run: async ({ api, event, args }) => {
    try {
      // 1) ตรวจสอบว่ามีไฟล์แนบหรือไม่
      if (!event.attachments || event.attachments.length === 0) {
        return api.sendMessage(
          "โปรดแนบรูปภาพเพื่อปรับความคมชัดด้วยคำสั่ง /sharpen ครับ",
          event.threadID
        );
      }

      // 2) เลือก attachment อันแรก (ถ้ามีหลายรูป จะเอาแค่รูปแรก)
      const attach = event.attachments[0];

      // ตรวจสอบว่าเป็น "รูปภาพ" หรือไม่
      if (attach.type !== "photo") {
        return api.sendMessage(
          "คำสั่งนี้รองรับเฉพาะไฟล์แนบเป็นรูปภาพเท่านั้นครับ!",
          event.threadID
        );
      }

      // ดึง URL ของรูปจาก attachment
      const imageUrl = attach.url;

      // 3) ดาวน์โหลดรูปภาพจาก URL ด้วย axios (responseType: 'arraybuffer')
      const response = await axios.get(imageUrl, { responseType: "arraybuffer" });
      const inputBuffer = Buffer.from(response.data);

      // 4) ใช้ Sharp เพื่อปรับคมชัด
      //    สามารถปรับเพิ่มหรือลดค่าการ sharpen() ได้ตามต้องการ
      const outputBuffer = await sharp(inputBuffer)
        .sharpen()   // หากต้องการกำหนดค่าระเอียด ให้ดูใน doc: https://sharp.pixelplumbing.com/api-operation#sharpen
        .toBuffer();

      // 5) ส่งรูปที่ประมวลผลเสร็จแล้วกลับไป
      //    (api.sendMessage รองรับการส่งไฟล์เป็น buffer ผ่าน key: 'attachment')
      api.sendMessage(
        {
          body: "นี่คือรูปที่ปรับความคมชัดแล้วจ้า! \n(Sharp by Node.js)",
          attachment: outputBuffer
        },
        event.threadID
      );

    } catch (err) {
      console.error("❌ เกิดข้อผิดพลาดในการปรับภาพให้คมชัด:", err);
      api.sendMessage(
        "ไม่สามารถปรับภาพให้คมชัดได้: " + err.message,
        event.threadID
      );
    }
  }
};
